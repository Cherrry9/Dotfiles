#!/usr/bin/env bash
# It's simple script to control a wirelless network connection
# using iwd and dhcpcd
interface='wlan0'

add() {
	list_all=$(iwctl station wlan0 get-networks | awk 'NR > 4 && $0 !~ /^$/ && $0 !~ />/ { print $1}')
	list_known=$(iwctl known-networks list | awk 'NR>4 && $0 !~ /^$/ { print $1 }')
	list=$(comm -23 <(sort -u <<<"$list_all") <(sort -u <<<"$list_known"))
	ssid=$(printf "%s" "$list" | dmenu -i -p "add") || return
	pass=$(dmenu -P -p "Enter password for $choice")
	iwctl --passphrase "$pass" station $interface connect "$ssid"
}

switch() {
	list_known=$(iwctl known-networks list | awk 'NR>4 && $0 !~ /^$/ { print $1 }')
	connected=$(iwctl station wlan0 show | awk 'NR>4 && /Connected/ { print $3 }')
	list=$(comm -23 <(sort -u <<<"$list_known") <(sort -u <<<"$connected"))
	[ -z "$list" ] && {
		notify-send "There is no network to switch."
		return
	}
	ssid=$(printf "%s" "$list" | dmenu -i -p "switch") || return
	iwctl station $interface connect "$ssid"
}

forget() {
	list=$(iwctl known-networks list | awk 'NR>4 && $0 !~ /^$/ { print $1 }')
	[ -z "$list" ] && {
		notify-send "There is no network to forget."
		return
	}
	ssid=$(printf "%s" "$list" | dmenu -i -p "forget") || return
	iwctl known-networks "$ssid" forget
}

scan() {
	iwctl station $interface scan
}

if ! pgrep -x iwd; then
	if ! (sudo -A systemctl start iwd && sudo -A systemctl enable iwd); then
		notify-send "❌ Error." "Unable to start iwd."
		exit
	fi
fi

if ! pgrep -x dhcpcd; then
	if ! (sudo -A systemctl start dhcpcd && sudo -A systemctl enable dhcpcd);then
		notify-send "❌ Error." "Unable to start dhcpcd."
		exit
	fi
fi

while true; do
	options="switch\nadd\nscan\nforget"
	choice=$(printf "%b" "$options" | dmenu -i -p "network") || exit
	case $choice in
	"add") add ;;
	"switch") switch ;;
	"forget") forget ;;
	esac
done
