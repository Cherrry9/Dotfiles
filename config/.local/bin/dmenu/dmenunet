#!/bin/bash
interface='wlp2s0'
conf='/etc/wpa_supplicant.conf'

network_add() {
	wpa_cli scan_internal 3
	wpa_cli scan
	sleep 3
	ssid=$(wpa_cli scan_results | awk 'NR>2 && NF == 5 && seen[$NF]++ == 0 {print $NF}' | dmenu -i -p "Select ESSID")
	[ -z "$ssid" ] && exit
	id=$(wpa_cli add_network | awk 'NR>1 { print $1 }')
	psk=$(dmenu -P -p "Password for $ssid" <&- && echo)
	wpa_cli <<EOF
    set_network $id ssid "$ssid"
EOF
	wpa_cli <<EOF
	set_network $id psk "$psk"
EOF
	wpa_cli enable_network "$id"
	wpa_cli select_network "$id"
	notify-send "$ssid successfully added."
}

network_switch() {
	mapfile -t ssid < <(wpa_cli list_networks | awk 'NR>2 && $0 !~ /CURRENT/ { print $2 }')

	[ "${#ssid}" -eq 0 ] && {
		notify-send "There isn't network to switch."
		exit
	}

	selected=$(echo "${ssid[@]}" | dmenu -i -p "Select ESSID")

	[ -z "$selected" ] && exit

	selected_id=$(wpa_cli list_networks | awk -v var="$selected" '$2 == var { print $1 }')
	wpa_cli select_network "$selected_id" && notify-send "$selected successfully conected."

}

network_remove() {
	# mapfile -t ssid <(wpa_cli list_networks | awk 'NR>2 && $0 !~ /CURRENT/ { print $2 }')
	mapfile -t ssid < <(wpa_cli list_networks | awk 'NR>2 { print $2 }')

	[ "${#ssid}" -eq 0 ] && {
		notify-send "There isn't network to delete."
		exit
	}

	selected=$(echo -n "${ssid[@]}" | dmenu -i -p "Select ESSID")
	selected_id=$(wpa_cli list_networks | awk -v var="$choice" '$2 == var { print $1 }')
	wpa_cli remove_network "$selected_id"
	notify-send "$selected successfully delted."
}

create_conf() {
	notify-send "Creating wpa_supplicant configuration file"
	sudo -A killall wpa_supplicant
	sudo -A tee -a $conf >/dev/null <<EOF
ctrl_interface=DIR=/run/wpa_supplicant GROUP=wheel
update_config=1
EOF
	sudo -A chmod 600 $conf
	sudo -A wpa_supplicant -B -i $interface -c $conf || {
		notify-send "wpa_supplicant failed to start correctly." "Try run it manually or edit configuration file ($conf)"
		exit
	}
}

if [ -f $conf ] && pgrep -x wpa_supplicant; then
	! wpa_cli list_networks >/dev/null && create_conf
elif ! pgrep -x wpa_supplicant; then
	sudo -A wpa_supplicant -B -i $interface -c $conf || create_conf
else
	create_conf
fi

options="switch network\nadd network\nremove network\nterminate"
choice=$(printf "$options" | dmenu -i -p "wpa supplicant")

case $choice in
"add network") network_add ;;
"remove network") network_remove ;;
"switch network") network_switch ;;
"terminate") wpa_cli terminate && notify-send "wpa_supplicant terminated." ;;
esac
wpa_cli save_config
